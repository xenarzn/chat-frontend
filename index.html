<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>KONO SAKAREPMU</title>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: 'Inter', sans-serif;
}

body {
  background: radial-gradient(circle at 20% 20%, #0f172a, #020617 70%);
  color: white;
  height: 100vh;
  overflow: hidden;
}

/* Soft premium particles */
body::before {
  content: "";
  position: fixed;
  width: 200%;
  height: 200%;
  background: radial-gradient(circle, rgba(37,99,235,0.15) 1px, transparent 1px);
  background-size: 80px 80px;
  animation: floatParticles 30s linear infinite;
  z-index: 0;
}

@keyframes floatParticles {
  from { transform: translate(0,0); }
  to { transform: translate(-200px,-200px); }
}

.app {
  position: relative;
  z-index: 1;
  max-width: 480px;
  margin: auto;
  height: 100vh;
  display: flex;
  flex-direction: column;
  background: rgba(2,6,23,0.75);
  backdrop-filter: blur(20px);
}

.header {
  padding: 16px;
  font-weight: 600;
  font-size: 18px;
  text-align: center;
  border-bottom: 1px solid rgba(255,255,255,0.05);
}

.auth {
  padding: 16px;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

input {
  padding: 12px;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,0.05);
  outline: none;
  background: rgba(30,41,59,0.6);
  color: white;
  font-size: 14px;
}

input:focus {
  border: 1px solid #2563eb;
}

button {
  padding: 12px;
  border-radius: 14px;
  border: none;
  background: linear-gradient(135deg,#2563eb,#1d4ed8);
  color: white;
  font-weight: 600;
  cursor: pointer;
  transition: 0.2s;
}

button:active {
  transform: scale(0.97);
}

.search-box {
  padding: 12px;
  display: flex;
  gap: 8px;
}

.results p {
  padding: 12px;
  cursor: pointer;
  border-bottom: 1px solid rgba(255,255,255,0.05);
}

.results p:hover {
  background: rgba(255,255,255,0.05);
}

.chat-area {
  flex: 1;
  overflow-y: auto;
  padding: 16px;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.bubble-wrapper {
  display: flex;
  flex-direction: column;
  max-width: 75%;
  animation: fadeIn 0.25s ease;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(6px); }
  to { opacity: 1; transform: translateY(0); }
}

.bubble {
  padding: 12px 16px;
  border-radius: 18px;
  font-size: 14px;
  word-wrap: break-word;
}

.me {
  align-self: flex-end;
  background: linear-gradient(135deg,#2563eb,#3b82f6);
  box-shadow: 0 6px 20px rgba(37,99,235,0.3);
}

.other {
  align-self: flex-start;
  background: rgba(30,41,59,0.8);
}

.status {
  font-size: 11px;
  margin-top: 4px;
  opacity: 0.8;
}

.sent {
  color: #9ca3af;
}

.read {
  color: #22c55e;
}

.input-area {
  display: flex;
  padding: 12px;
  gap: 8px;
  background: rgba(2,6,23,0.9);
}

.input-area input {
  flex: 1;
}

@media (max-width: 500px) {
  .app {
    max-width: 100%;
  }
}
</style>
</head>

<body>
<div class="app">
  <div class="header">Premium DM Chat</div>

  <div class="auth">
    <input id="regUser" placeholder="Username">
    <input id="regPass" type="password" placeholder="Password">
    <button onclick="register()">Register</button>

    <input id="logUser" placeholder="Login Username">
    <input id="logPass" type="password" placeholder="Password">
    <button onclick="login()">Login</button>
  </div>

  <div class="search-box">
    <input id="searchUser" placeholder="Search username...">
    <button onclick="search()">Find</button>
  </div>

  <div class="results" id="results"></div>
  <div class="chat-area" id="chat"></div>

  <div class="input-area">
    <input id="target" placeholder="Target username">
    <input id="message" placeholder="Type message...">
    <button onclick="send()">Send</button>
  </div>
</div>

<script>
const API = "https://chat-backend-u4en.onrender.com";
const socket = io(API);
let currentUser = "";

function formatGMT7(date){
  const d = new Date(date);
  const gmt7 = new Date(d.getTime() + (7 * 60 * 60 * 1000));
  return gmt7.toLocaleTimeString("id-ID", {
    hour: "2-digit",
    minute: "2-digit"
  });
}

function createBubble(data, isMe){
  const wrapper = document.createElement("div");
  wrapper.classList.add("bubble-wrapper");
  wrapper.style.alignSelf = isMe ? "flex-end" : "flex-start";

  const bubble = document.createElement("div");
  bubble.classList.add("bubble", isMe ? "me" : "other");
  bubble.innerText = data.sender + ": " + data.message;

  wrapper.appendChild(bubble);

  if(isMe){
    const status = document.createElement("div");
    status.classList.add("status");
    status.id = "status-" + data.id;

    if(data.readAt){
      status.classList.add("read");
      status.innerText = "✓✓ Dibaca " + formatGMT7(data.readAt) + " GMT+7";
    } else {
      status.classList.add("sent");
      status.innerText = "✓ Terkirim";
    }

    wrapper.appendChild(status);
  }

  chat.appendChild(wrapper);
  chat.scrollTop = chat.scrollHeight;
}

async function register(){
  await fetch(API + "/register", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({
      username: regUser.value,
      password: regPass.value
    })
  });
  alert("Registered");
}

async function login(){
  const res = await fetch(API + "/login", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({
      username: logUser.value,
      password: logPass.value
    })
  });
  const data = await res.json();
  if(data.success){
    currentUser = logUser.value;
    alert("Login success");
  } else {
    alert("Login failed");
  }
}

async function search(){
  const res = await fetch(API + "/search/" + searchUser.value);
  const users = await res.json();
  results.innerHTML = users.map(u =>
    `<p onclick="selectUser('${u.username}')">${u.username}</p>`
  ).join("");
}

function selectUser(u){
  target.value = u;
}

function send(){
  if(!currentUser) return alert("Login first");

  const payload = {
    id: Date.now().toString(),
    sender: currentUser,
    receiver: target.value,
    message: message.value,
    createdAt: new Date().toISOString(),
    readAt: null
  };

  socket.emit("send_message", payload);
  createBubble(payload, true);
  message.value = "";
}

socket.on("receive_message", (data) => {
  if(data.sender === currentUser || data.receiver === currentUser){
    createBubble(data, data.sender === currentUser);

    if(data.receiver === currentUser){
      socket.emit("message_read", {
        messageId: data.id,
        readAt: new Date().toISOString()
      });
    }
  }
});

socket.on("message_read_update", (data) => {
  const status = document.getElementById("status-" + data.messageId);
  if(status){
    status.classList.remove("sent");
    status.classList.add("read");
    status.innerText = "✓✓ Dibaca " + formatGMT7(data.readAt) + " GMT+7";
  }
});
</script>
</body>
</html>
