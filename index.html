<!DOCTYPE html>
<html>
<head>
  <title>Simple Chat</title>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body>
  <h2>Register</h2>
  <input id="regUser" placeholder="Username">
  <input id="regPass" placeholder="Password" type="password">
  <button onclick="register()">Register</button>

  <h2>Login</h2>
  <input id="logUser" placeholder="Username">
  <input id="logPass" placeholder="Password" type="password">
  <button onclick="login()">Login</button>

  <h2>Search User</h2>
  <input id="searchUser" placeholder="Search username">
  <button onclick="search()">Search</button>
  <div id="results"></div>

  <h2>DM Chat</h2>
  <input id="target" placeholder="Target username">
  <div id="chat"></div>
  <input id="message" placeholder="Message">
  <button onclick="send()">Send</button>

<script>
const API = "YOUR_RENDER_BACKEND_URL";
const socket = io(API);
let currentUser = "";

async function register() {
  const username = regUser.value;
  const password = regPass.value;
  await fetch(API + "/register", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ username, password })
  });
  alert("Registered");
}

async function login() {
  const username = logUser.value;
  const password = logPass.value;
  const res = await fetch(API + "/login", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ username, password })
  });
  const data = await res.json();
  if(data.success){
    currentUser = username;
    alert("Login success");
  } else {
    alert("Login failed");
  }
}

async function search() {
  const q = searchUser.value;
  const res = await fetch(API + "/search/" + q);
  const users = await res.json();
  results.innerHTML = users.map(u => 
    `<p onclick="selectUser('${u.username}')">${u.username}</p>`
  ).join("");
}

function selectUser(u){
  target.value = u;
}

function send(){
  const msg = message.value;
  const receiver = target.value;
  socket.emit("send_message", {
    sender: currentUser,
    receiver: receiver,
    message: msg
  });
}

socket.on("receive_message", (data) => {
  if(data.sender === currentUser || data.receiver === currentUser){
    chat.innerHTML += `<p><b>${data.sender}:</b> ${data.message}</p>`;
  }
});
</script>
</body>
</html>
