<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Chat - XENZDOCHAT</title>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

<style>
*{
  margin:0;
  padding:0;
  box-sizing:border-box;
  font-family:'Inter',sans-serif;
}

body{
  background: radial-gradient(circle at 20% 20%, #0f172a, #020617 70%);
  color:white;
  height:100dvh;
}

.app{
  max-width:480px;
  margin:auto;
  height:100dvh;
  display:flex;
  flex-direction:column;
  background:rgba(2,6,23,0.9);
  backdrop-filter:blur(20px);
}

.header{
  padding:12px 16px;
  border-bottom:1px solid rgba(255,255,255,0.05);
  display:flex;
  align-items:center;
  justify-content:space-between;
  background:rgba(2,6,23,0.95);
}

.profile{
  display:flex;
  align-items:center;
  gap:10px;
}

.my-avatar{
  width:40px;
  height:40px;
  border-radius:50%;
  object-fit:cover;
  border:2px solid #2563eb;
}

.username{
  font-weight:600;
  font-size:16px;
}

.logout{
  background:#ef4444;
  padding:6px 12px;
  border-radius:10px;
  font-size:12px;
  cursor:pointer;
}

.search-box{
  padding:12px;
  display:flex;
  gap:8px;
}

input{
  padding:12px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,0.05);
  background:#1e293b;
  color:white;
  outline:none;
  width:100%;
  font-size:16px;
}

button{
  padding:12px 14px;
  border:none;
  border-radius:14px;
  background:linear-gradient(135deg,#2563eb,#1d4ed8);
  color:white;
  font-weight:600;
  cursor:pointer;
}

.mic-btn{
  background:#0ea5e9;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:18px;
  width:48px;
}

.mic-recording{
  background:#ef4444 !important;
}

.chat-area{
  flex:1;
  overflow-y:auto;
  padding:16px;
  padding-bottom:95px;
  display:flex;
  flex-direction:column;
  gap:12px;
}

.message-row{
  display:flex;
  align-items:flex-end;
  gap:8px;
}

.me{ justify-content:flex-end; }
.other{ justify-content:flex-start; }

.avatar{
  width:34px;
  height:34px;
  border-radius:50%;
  object-fit:cover;
  background:#1e293b;
}

.bubble-wrap{
  max-width:75%;
  display:flex;
  flex-direction:column;
}

.sender-name{
  font-size:11px;
  opacity:0.7;
  margin-bottom:2px;
}

.bubble{
  padding:12px 16px;
  border-radius:18px;
  font-size:14px;
  word-wrap:break-word;
}

audio{
  width:180px;
}

.me .bubble{ background:#2563eb; }
.other .bubble{ background:#1e293b; }

.meta{
  font-size:11px;
  margin-top:4px;
  opacity:0.85;
}

.sent{color:#9ca3af;}
.read{color:#22c55e;}

.input-area{
  position:fixed;
  bottom:0;
  left:0;
  right:0;
  max-width:480px;
  margin:auto;
  display:flex;
  gap:8px;
  padding:10px;
  padding-bottom:env(safe-area-inset-bottom);
  background:rgba(2,6,23,0.98);
  border-top:1px solid rgba(255,255,255,0.05);
}
</style>
</head>
<body>

<div class="app">
  <div class="header">
    <div class="profile">
      <img id="myPP" class="my-avatar">
      <div class="username" id="userLabel"></div>
    </div>
    <div class="logout" onclick="logout()">Logout</div>
  </div>

  <div class="search-box">
    <input id="searchUser" placeholder="Search username">
    <button onclick="search()">Find</button>
  </div>

  <div id="results"></div>
  <div class="chat-area" id="chat"></div>

  <div class="input-area">
    <input id="target" placeholder="Target username">
    <input id="message" placeholder="Type message">
    <button onclick="send()">Send</button>
    <button id="micBtn" class="mic-btn" onclick="toggleRecording()">ðŸŽ¤</button>
  </div>
</div>

<script>
const API = "https://chat-backend-u4en.onrender.com";
const socket = io(API);

const userLabel = document.getElementById("userLabel");
const myPP = document.getElementById("myPP");
const chat = document.getElementById("chat");
const target = document.getElementById("target");
const message = document.getElementById("message");
const searchUser = document.getElementById("searchUser");
const results = document.getElementById("results");
const micBtn = document.getElementById("micBtn");

let currentUser = localStorage.getItem("chat_user");
let currentTarget = localStorage.getItem("chat_target") || "";

let mediaRecorder;
let audioChunks = [];
let isRecording = false;

if(!currentUser){
  window.location.href = "login.html";
}

userLabel.innerText = "@" + currentUser;

async function loadMyPP(){
  const res = await fetch(API + "/user/" + currentUser);
  const data = await res.json();
  myPP.src = data?.profilePicture || "https://ui-avatars.com/api/?name=" + currentUser;
}
loadMyPP();

socket.on("connect", () => {
  socket.emit("join", currentUser);
});

function logout(){
  localStorage.clear();
  window.location.href = "login.html";
}

function formatWIB(date){
  return new Intl.DateTimeFormat("id-ID",{
    timeZone:"Asia/Jakarta",
    hour:"2-digit",
    minute:"2-digit",
    hour12:false
  }).format(new Date(date)) + " WIB";
}

function createMessage(data){
  const isMe = data.sender === currentUser;

  const row = document.createElement("div");
  row.className = "message-row " + (isMe ? "me" : "other");

  const avatar = document.createElement("img");
  avatar.className = "avatar";
  avatar.src = data.senderPP || "https://ui-avatars.com/api/?name=" + data.sender;

  const wrap = document.createElement("div");
  wrap.className = "bubble-wrap";

  const name = document.createElement("div");
  name.className = "sender-name";
  name.innerText = isMe ? "You" : "@" + data.sender;

  const bubble = document.createElement("div");
  bubble.className = "bubble";

  if(data.type === "audio"){
    const audio = document.createElement("audio");
    audio.controls = true;
    audio.src = data.message;
    bubble.appendChild(audio);
  }else{
    bubble.innerText = data.message;
  }

  wrap.appendChild(name);
  wrap.appendChild(bubble);

  if(isMe){
    const meta = document.createElement("div");
    meta.className = "meta sent";
    meta.id = "msg-"+data._id;
    meta.innerText = "âœ“ " + formatWIB(data.createdAt);
    wrap.appendChild(meta);
  }

  if(!isMe) row.appendChild(avatar);
  row.appendChild(wrap);
  if(isMe) row.appendChild(avatar);

  chat.appendChild(row);
  chat.scrollTop = chat.scrollHeight;

  if(!isMe){
    socket.emit("read_message", data._id);
  }
}

async function toggleRecording(){
  if(!currentTarget){
    alert("Pilih target chat dulu");
    return;
  }

  if(!isRecording){
    const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
    mediaRecorder = new MediaRecorder(stream);
    audioChunks = [];

    mediaRecorder.ondataavailable = e => {
      audioChunks.push(e.data);
    };

    mediaRecorder.onstop = async () => {
      const blob = new Blob(audioChunks,{ type:"audio/webm" });
      const reader = new FileReader();
      reader.onloadend = () => {
        socket.emit("send_message",{
          sender: currentUser,
          receiver: currentTarget,
          message: reader.result,
          type: "audio"
        });
      };
      reader.readAsDataURL(blob);
    };

    mediaRecorder.start();
    isRecording = true;
    micBtn.classList.add("mic-recording");
    micBtn.innerText = "âº";
  }else{
    mediaRecorder.stop();
    isRecording = false;
    micBtn.classList.remove("mic-recording");
    micBtn.innerText = "ðŸŽ¤";
  }
}

async function loadHistory(){
  if(!currentTarget) return;
  chat.innerHTML = "";

  const res = await fetch(`${API}/messages/${currentUser}/${currentTarget}`);
  const messages = await res.json();

  messages.forEach(createMessage);
}

async function search(){
  const res = await fetch(API + "/search/" + searchUser.value);
  const users = await res.json();
  results.innerHTML = users.map(u =>
    `<p style="padding:10px;cursor:pointer" onclick="selectUser('${u.username}')">@${u.username}</p>`
  ).join("");
}

function selectUser(u){
  currentTarget = u;
  target.value = u;
  localStorage.setItem("chat_target", u);
  loadHistory();
}

function send(){
  if(!target.value || !message.value) return;

  currentTarget = target.value;
  localStorage.setItem("chat_target", currentTarget);

  socket.emit("send_message", {
    sender: currentUser,
    receiver: currentTarget,
    message: message.value,
    type: "text"
  });

  message.value="";
}

socket.on("receive_message",(data)=>{
  if(currentTarget === data.sender || currentTarget === data.receiver){
    createMessage(data);
  }
});

socket.on("message_read",(data)=>{
  const el = document.getElementById("msg-"+data._id);
  if(el){
    el.className = "meta read";
    el.innerText = "âœ“âœ“ Dibaca " + formatWIB(data.readAt);
  }
});

if(currentTarget){
  target.value = currentTarget;
  loadHistory();
}
</script>
</body>
</html>
