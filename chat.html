<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Chat - XENZDOCHAT</title>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

<style>
*{ margin:0; padding:0; box-sizing:border-box; font-family:'Inter',sans-serif; }

body{
  background: radial-gradient(circle at 20% 20%, #0f172a, #020617 70%);
  color:white;
  height:100dvh;
  overflow: hidden;
}

.app{
  max-width:480px;
  margin:auto;
  height:100dvh;
  display:flex;
  flex-direction:column;
  background:rgba(2,6,23,0.9);
  backdrop-filter:blur(20px);
  position: relative;
}

/* Header Styles */
.header{
  padding:12px 16px;
  border-bottom:1px solid rgba(255,255,255,0.1);
  display:flex;
  align-items:center;
  gap: 12px;
  background:rgba(2,6,23,0.95);
  z-index: 10;
}

.menu-btn {
  background: none;
  border: none;
  color: white;
  font-size: 20px;
  cursor: pointer;
  padding: 5px;
}

.profile-target{
  display:flex;
  align-items:center;
  gap:12px;
  flex: 1;
  cursor: pointer;
}

.target-avatar{
  width:38px;
  height:38px;
  border-radius:50%;
  object-fit:cover;
  border:2px solid #2563eb;
  background: #1e293b;
}

.target-info .name{ font-weight:600; font-size:15px; display: block; }
.target-info .status{ font-size:10px; color: #22c55e; }

/* Sidebar History */
.history-sidebar {
  position: absolute;
  top: 0;
  left: -100%;
  width: 80%;
  height: 100%;
  background: #0f172a;
  z-index: 100;
  transition: 0.3s ease;
  box-shadow: 10px 0 30px rgba(0,0,0,0.5);
  padding: 20px;
}

.history-sidebar.active { left: 0; }

.history-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  border-bottom: 1px solid rgba(255,255,255,0.1);
  padding-bottom: 10px;
}

.history-list {
  display: flex;
  flex-direction: column;
  gap: 10px;
  overflow-y: auto;
}

.history-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px;
  border-radius: 12px;
  background: rgba(255,255,255,0.03);
  cursor: pointer;
}

.history-item:hover { background: rgba(37, 99, 235, 0.2); }

/* Chat Area */
.chat-area{
  flex:1;
  overflow-y:auto;
  padding:16px;
  display:flex;
  flex-direction:column;
  gap:12px;
  padding-bottom: 80px; 
}

.message-row{ display:flex; align-items:flex-end; gap:8px; }
.me{ justify-content:flex-end; }
.other{ justify-content:flex-start; }

.bubble{
  padding:10px 14px;
  border-radius:18px;
  font-size:14px;
  word-wrap:break-word;
  max-width: 280px;
}

.me .bubble{ background:#2563eb; border-bottom-right-radius: 4px;}
.other .bubble{ background:#1e293b; border-bottom-left-radius: 4px;}

.meta{ font-size:10px; margin-top:4px; opacity: 0.6; }

/* Input Area */
.input-area{
  position:fixed;
  bottom:0;
  left:0;
  right:0;
  max-width:480px;
  margin:auto;
  display:flex;
  align-items: center;
  gap:8px;
  padding:12px;
  padding-bottom:calc(12px + env(safe-area-inset-bottom));
  background:rgba(15, 23, 42, 0.98);
  border-top:1px solid rgba(255,255,255,0.05);
}

input#message {
  flex: 1;
  padding: 12px 16px;
  border-radius: 25px;
  border: 1px solid rgba(255,255,255,0.1);
  background: #1e293b;
  color: white;
  outline: none;
}

.btn-icon {
  background: #2563eb;
  width: 42px;
  height: 42px;
  border-radius: 50%;
  border: none;
  color: white;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}

.mic-btn { background: rgba(255,255,255,0.1); }
.mic-recording { background: #ef4444 !important; }

audio { width: 200px; }
</style>
</head>
<body>

<div class="app">
  <div id="sidebar" class="history-sidebar">
    <div class="history-header">
      <h3>Chats History</h3>
      <button onclick="toggleSidebar()" style="background:none; border:none; color:white; font-size:20px;">âœ•</button>
    </div>
    <div id="historyList" class="history-list">
      </div>
  </div>

  <div class="header">
    <button class="menu-btn" onclick="toggleSidebar()">â˜°</button>
    <div class="profile-target" onclick="addNewChat()">
      <img id="targetPP" class="target-avatar" src="https://ui-avatars.com/api/?name=User">
      <div class="target-info">
        <span class="name" id="targetLabel">Pilih Chat...</span>
        <span class="status">Tap untuk cari user</span>
      </div>
    </div>
  </div>

  <div class="chat-area" id="chat"></div>

  <div class="input-area">
    <button id="micBtn" class="btn-icon mic-btn" onclick="toggleRecording()">ðŸŽ¤</button>
    <input id="message" placeholder="Tulis pesan..." autocomplete="off">
    <button class="btn-icon" onclick="send()">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="white"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
    </button>
  </div>
</div>

<script>
const API = "https://chat-backend-u4en.onrender.com";
const socket = io(API);

const chat = document.getElementById("chat");
const message = document.getElementById("message");
const targetLabel = document.getElementById("targetLabel");
const targetPP = document.getElementById("targetPP");
const micBtn = document.getElementById("micBtn");
const historyList = document.getElementById("historyList");
const sidebar = document.getElementById("sidebar");

let currentUser = localStorage.getItem("chat_user");
let currentTarget = localStorage.getItem("chat_target") || "";
let chatHistory = JSON.parse(localStorage.getItem("chat_history") || "[]");

if(!currentUser) window.location.href = "login.html";

function toggleSidebar() {
  sidebar.classList.toggle("active");
  renderHistory();
}

function addNewChat() {
  const user = prompt("Masukkan username tujuan:");
  if(user) selectUser(user);
}

function saveToHistory(username) {
  if(!chatHistory.includes(username)) {
    chatHistory.unshift(username);
    if(chatHistory.length > 15) chatHistory.pop();
    localStorage.setItem("chat_history", JSON.stringify(chatHistory));
  }
}

function renderHistory() {
  historyList.innerHTML = chatHistory.length ? "" : "<p style='opacity:0.5; text-align:center;'>Belum ada history</p>";
  chatHistory.forEach(user => {
    const div = document.createElement("div");
    div.className = "history-item";
    div.innerHTML = `
      <img src="https://ui-avatars.com/api/?name=${user}" style="width:30px; border-radius:50%">
      <span>@${user}</span>
    `;
    div.onclick = () => {
      selectUser(user);
      toggleSidebar();
    };
    historyList.appendChild(div);
  });
}

function selectUser(u){
  currentTarget = u;
  localStorage.setItem("chat_target", u);
  saveToHistory(u);
  updateTargetUI(u);
  loadHistory();
}

async function updateTargetUI(username) {
  targetLabel.innerText = "@" + username;
  const res = await fetch(API + "/user/" + username);
  const data = await res.json();
  targetPP.src = data?.profilePicture || "https://ui-avatars.com/api/?name=" + username;
}

socket.on("connect", () => socket.emit("join", currentUser));

async function loadHistory(){
  if(!currentTarget) return;
  chat.innerHTML = "";
  const res = await fetch(`${API}/messages/${currentUser}/${currentTarget}`);
  const messages = await res.json();
  messages.forEach(createMessage);
}

function createMessage(data){
  const isMe = data.sender === currentUser;
  const row = document.createElement("div");
  row.className = "message-row " + (isMe ? "me" : "other");
  const bubble = document.createElement("div");
  bubble.className = "bubble";

  if(data.type === "audio"){
    const audio = document.createElement("audio");
    audio.controls = true; audio.src = data.message;
    bubble.appendChild(audio);
  } else {
    bubble.innerText = data.message;
  }

  const meta = document.createElement("div");
  meta.className = "meta";
  meta.innerText = new Date(data.createdAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

  const wrap = document.createElement("div");
  wrap.appendChild(bubble);
  wrap.appendChild(meta);
  row.appendChild(wrap);
  chat.appendChild(row);
  chat.scrollTop = chat.scrollHeight;
}

function send(){
  const val = message.value.trim();
  if(!currentTarget || !val) return;
  socket.emit("send_message", {
    sender: currentUser, receiver: currentTarget,
    message: val, type: "text"
  });
  message.value = "";
}

let mediaRecorder;
let audioChunks = [];
let isRecording = false;

async function toggleRecording(){
  if(!currentTarget) return alert("Pilih target dulu");
  if(!isRecording){
    const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
    mediaRecorder = new MediaRecorder(stream);
    audioChunks = [];
    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
    mediaRecorder.onstop = () => {
      const blob = new Blob(audioChunks,{ type:"audio/webm" });
      const reader = new FileReader();
      reader.onloadend = () => {
        socket.emit("send_message",{
          sender: currentUser, receiver: currentTarget,
          message: reader.result, type: "audio"
        });
      };
      reader.readAsDataURL(blob);
    };
    mediaRecorder.start();
    isRecording = true;
    micBtn.classList.add("mic-recording");
  }else{
    mediaRecorder.stop();
    isRecording = false;
    micBtn.classList.remove("mic-recording");
  }
}

socket.on("receive_message",(data)=>{
  if(currentTarget === data.sender || currentTarget === data.receiver){
    createMessage(data);
  }
  if(data.sender !== currentUser) saveToHistory(data.sender);
});

if(currentTarget) {
  updateTargetUI(currentTarget);
  loadHistory();
}
message.addEventListener("keypress", (e) => { if(e.key === "Enter") send(); });
</script>
</body>
</html>
