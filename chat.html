<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat - AVTUR CHAT</title>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

<style>
*{
  margin:0;
  padding:0;
  box-sizing:border-box;
  font-family:'Inter',sans-serif;
}

body{
  background: radial-gradient(circle at 20% 20%, #0f172a, #020617 70%);
  color:white;
  height:100vh;
  overflow:hidden;
}

.app{
  max-width:480px;
  margin:auto;
  height:100vh;
  display:flex;
  flex-direction:column;
  background:rgba(2,6,23,0.85);
  backdrop-filter:blur(20px);
}

.header{
  padding:16px;
  font-weight:600;
  font-size:18px;
  border-bottom:1px solid rgba(255,255,255,0.05);
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.logout{
  background:#ef4444;
  padding:6px 12px;
  border-radius:10px;
  font-size:12px;
  cursor:pointer;
}

.search-box{
  padding:12px;
  display:flex;
  gap:8px;
}

input{
  padding:12px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,0.05);
  background:#1e293b;
  color:white;
  outline:none;
  width:100%;
}

button{
  padding:12px;
  border:none;
  border-radius:14px;
  background:linear-gradient(135deg,#2563eb,#1d4ed8);
  color:white;
  font-weight:600;
  cursor:pointer;
}

.results p{
  padding:12px;
  border-bottom:1px solid rgba(255,255,255,0.05);
  cursor:pointer;
}

.chat-area{
  flex:1;
  overflow-y:auto;
  padding:16px;
  display:flex;
  flex-direction:column;
  gap:10px;
}

.bubble-wrap{
  max-width:75%;
  display:flex;
  flex-direction:column;
}

.me{align-self:flex-end;}
.other{align-self:flex-start;}

.bubble{
  padding:12px 16px;
  border-radius:18px;
  font-size:14px;
}

.me .bubble{
  background:#2563eb;
}

.other .bubble{
  background:#1e293b;
}

.status{
  font-size:11px;
  margin-top:4px;
  opacity:0.8;
}

.sent{color:#9ca3af;}
.read{color:#22c55e;}

.input-area{
  display:flex;
  gap:8px;
  padding:12px;
}
</style>
</head>
<body>

<div class="app">
  <div class="header">
    <span id="userLabel">Chat</span>
    <div class="logout" onclick="logout()">Logout</div>
  </div>

  <div class="search-box">
    <input id="searchUser" placeholder="Search username">
    <button onclick="search()">Find</button>
  </div>

  <div id="results"></div>
  <div class="chat-area" id="chat"></div>

  <div class="input-area">
    <input id="target" placeholder="Target username">
    <input id="message" placeholder="Type message">
    <button onclick="send()">Send</button>
  </div>
</div>

<script>
const API = "https://chat-backend-u4en.onrender.com";
const socket = io(API);

let currentUser = localStorage.getItem("chat_user");

if(!currentUser){
  window.location.href = "login.html";
}

userLabel.innerText = "@" + currentUser;

function logout(){
  localStorage.removeItem("chat_user");
  window.location.href = "login.html";
}

function formatGMT7(date){
  const d = new Date(date);
  const gmt7 = new Date(d.getTime() + (7*60*60*1000));
  return gmt7.toLocaleTimeString("id-ID",{hour:"2-digit",minute:"2-digit"});
}

function createBubble(data,isMe){
  const wrap = document.createElement("div");
  wrap.className = "bubble-wrap " + (isMe ? "me" : "other");

  const bubble = document.createElement("div");
  bubble.className = "bubble";
  bubble.innerText = data.sender + ": " + data.message;

  wrap.appendChild(bubble);

  if(isMe){
    const status = document.createElement("div");
    status.className = "status sent";
    status.id = "msg-"+data.id;
    status.innerText = "✓ Terkirim";
    wrap.appendChild(status);
  }

  chat.appendChild(wrap);
  chat.scrollTop = chat.scrollHeight;
}

async function search(){
  const res = await fetch(API + "/search/" + searchUser.value);
  const users = await res.json();
  results.innerHTML = users.map(u =>
    `<p onclick="selectUser('${u.username}')">${u.username}</p>`
  ).join("");
}

function selectUser(u){
  target.value = u;
}

function send(){
  if(!target.value || !message.value) return;

  const data = {
    id: Date.now().toString(),
    sender: currentUser,
    receiver: target.value,
    message: message.value,
    createdAt: new Date().toISOString()
  };

  socket.emit("send_message", data);
  createBubble(data,true);
  message.value="";
}

socket.on("receive_message",(data)=>{
  if(data.sender===currentUser || data.receiver===currentUser){
    createBubble(data,data.sender===currentUser);

    if(data.receiver===currentUser){
      socket.emit("message_read",{
        messageId:data.id,
        readAt:new Date().toISOString()
      });
    }
  }
});

socket.on("message_read_update",(data)=>{
  const el=document.getElementById("msg-"+data.messageId);
  if(el){
    el.className="status read";
    el.innerText="✓✓ Dibaca "+formatGMT7(data.readAt)+" GMT+7";
  }
});
</script>

</body>
</html>
